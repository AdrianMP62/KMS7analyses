---
title: "Kimberley Mound Springs invertebrate analyses"
author: "Adrian Pinder"
date and time: '`r Sys.time()`'
output: html_document
software: 'RStudio: Version 1.1.456 – © 2009-2018 RStudio, Inc. R version: `r getRversion()`'
editor_options: 
  chunk_output_type: console
---

Git repository https://github.com/AdrianMP62/KMS7analyses  

RStudio: Version 1.1.456 – © 2009-2018 RStudio, Inc. R version: `r getRversion()`  
Date and time: `r Sys.time()`

Uses the following datafiles:  
  
ionic composition mgl.csv (2016-17 ionic composition data) with columns: Year,CO3,Ca,Cl,HCO3,K,Mg,Na,SO4 (values as mg/L) and site codes (KMS01, KMS02 etc.) as row.headings  
KMS17_invert_data.csv (2017 KMS invertebrate presence/absence data)  
ALL KMS-VBM data.csv (all KMS invertebrate presence/absence data - 1999-2017 with columns: "Class","Family","LOWESTID","LOWESTIDNC", then sample headings as year-two digit KMS code-sample type : P = Plankton, B = Benthic, PB = Plankton+Benthic, C = Core. Blanks already replaced with zeros  

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(out.width='1.0\\linewidth')
set.seed(1234)
```


```{r}
options(scipen=999)

```

```{r, message=FALSE, results='hide'}
library(vegan)
library(ggplot2)
library(data.table)
library(simba)
library(Ternary)
library(ggplot2)
library(RColorBrewer)
```

#Ternary diagrams of ionic composition


```{r include=TRUE, message=FALSE}
#load data files
MgL.data <- read.csv("ionic composition mgl.csv", row.names=1)
MgL.data <- MgL.data[, 1:9]
```

```{r}
#create new data frame
Meq.data <- MgL.data
Meq.data$Na <- Meq.data$Na*0.0435
Meq.data$Ca <- Meq.data$Ca*0.0499
Meq.data$Mg <- Meq.data$Mg*0.0823
Meq.data$K <- Meq.data$K*0.0256
Meq.data$Cl <- Meq.data$Cl*0.0282
Meq.data$SO4 <- Meq.data$SO4*0.0208
Meq.data$HCO3 <- Meq.data$HCO3*0.0164
Meq.data$CO3 <- Meq.data$CO3*0.0333

```

```{r}
write.csv(Meq.data, "meq-data.csv")
```



```{r}
#calculate total anions and cations
Totals.cations <- rowSums(Meq.data[, colnames(Meq.data) %like% "Na|Ca|Mg|K"])
Totals.anions <- rowSums(Meq.data[, colnames(Meq.data) %like% "Cl|HCO3|CO3|SO4"])
```

```{r}
#calculate percentages
Meq.per <- data.frame(row.names = row.names(Meq.data))
Meq.per$Na <- Meq.data$Na/Totals.cations*100
Meq.per$Ca <- Meq.data$Ca/Totals.cations*100
Meq.per$Mg <- Meq.data$Mg/Totals.cations*100
Meq.per$K <- Meq.data$K/Totals.cations*100
Meq.per$Cl <- Meq.data$Cl/Totals.anions*100
Meq.per$SO4 <- Meq.data$SO4/Totals.anions*100
Meq.per$HCO3 <- Meq.data$HCO3/Totals.anions*100
Meq.per$CO3 <- Meq.data$CO3/Totals.anions*100
Meq.per$HC <- Meq.per$CO3 + Meq.per$HCO3
Meq.per$NaK <- Meq.per$Na + Meq.per$K
Meq.per$year <- MgL.data$Year

```

```{r}
Meq.per.16 <- Meq.per[Meq.per$year %like% "2016", ]
Meq.per.17 <- Meq.per[Meq.per$year %like% "2017", ]
```

```{r}
#create new datasets with just 3 anion and 3 cation variables for Ternary plots
Cations <- Meq.per[, colnames(Meq.per) %like% "NaK|Mg|Ca|year"]
row.names(Cations) <- c(1,8,10,11,12,13,14,15,16,4,19,20,21,22,23)
Anions <- Meq.per[, colnames(Meq.per) %like% "SO4|HC|Cl|year"]
Anions <- subset(Anions, select=-c(03)) #drop HCO3 from Anions but retain HC (=HCO3+CO3)
row.names(Anions) <- c(1,8,10,11,12,13,14,15,16,4,19,20,21,22,23)
```

```{r Ternary diagrams with Na+K and HCO3+CO3}
#create ternary diagrams
par(mfrow=c(1, 2), mar=rep(0.1, 4))
#first Ternary diagram
TernaryPlot(alab="Ca", blab="Mg", clab="NaK",
            point='up', lab.cex=1.2, grid.minor.lines = 0,
            grid.lty='solid', col=rgb(0.9, 0.9, 0.9), grid.col='white', 
            axis.col=rgb(0.6, 0.6, 0.6), ticks.col=rgb(0.6, 0.6, 0.6),
            padding=0.08)
AddToTernary(points, Cations[Cations$year %like% "2016", 1:3], pch=21, cex=symbol.size(Meq.per.16$Na/Meq.per.16$NaK, cex.max=5), col="red")
#AddToTernary(text, Anions, row.names(Cations), cex=0.7, font=2)
AddToTernary(points, Cations[Cations$year %like% "2017", 1:3], pch=21, cex=symbol.size(Meq.per.17$Na/Meq.per.17$NaK, cex.max=5), col="blue")
#AddToTernary(text, Anions, row.names(Cations), cex=0.7, font=2)
#AddToTernary(text, Cations, row.names(Cations), cex=0.7, font=2)
#second Ternary diagram
TernaryPlot(alab="Cl", blab="SO4", clab="HCO3+CO3",
            point='down', lab.cex=1.2, grid.minor.lines = 0,
            grid.lty='solid', col=rgb(0.9, 0.9, 0.9), grid.col='white', 
            axis.col=rgb(0.6, 0.6, 0.6), ticks.col=rgb(0.6, 0.6, 0.6),
            padding=0.08)
AddToTernary(points, Anions[Anions$year %like% "2016", 1:3], pch=21, cex=Meq.per.16$HCO3/Meq.per.16$HC*10, col="red")
#AddToTernary(text, Anions, row.names(Cations), cex=0.7, font=2)
AddToTernary(points, Anions[Anions$year %like% "2017", 1:3], pch=21, cex=Meq.per.17$HCO3/Meq.per.17$HC*10, col="blue")
#AddToTernary(text, Anions, row.names(Cations), cex=0.7, font=2)
```



#Multivariate analyses of 2017 data only

<!-- use stringsAsfactors so the 1's are numbers -->
```{r upload data, results=FALSE}
data1 <- read.csv("KMS17_invert_data.csv", stringsAsFactors = FALSE, check.names = FALSE)
str(data1)
```

```{r strip data down to analysis matrix}
data2 <- data1[, -2]
data2 <- data2[-c(1:2), ]
row.names(data2) <-data2[, 1]
data2 <- data2[, -1]
colnames(data2) <- data2[1, ]
data2 <- data2[-1, ]
species <- row.names(data2) #extract list of species
samples <- colnames(data2) #extract list of samples
data2[data2==""]  <- 0  #replace blanks with 0
data2 = as.matrix(as.data.frame(lapply(data2[, 1:26], as.numeric))) #convert data to numeric
row.names(data2) <- species
data2 <- t(data2)
```

```{r extract list of sample types}
sample.type <- substring(samples, 3,3)
```

```{r nMDS ordination in vegan, results=FALSE}
data2.mds <- metaMDS(data2, distance="bray")
data2.pts <- as.data.frame(data2.mds$points)
```

```{r}
data2.mds
```

```{r}
data2.mds.plot <- ggplot(data2.pts, aes(x=MDS1, y=MDS2)) + coord_fixed(ratio = 1)  + geom_point(aes(size=2, colour= sample.type)) + geom_text(aes(label = samples), vjust=0.5, hjust=1)
```

```{r}
print(data2.mds.plot)
```

#Richness by major taxonomic group for all Kimberley Springs

```{r Read species matrix}
data.rich <- read.csv("ALL KMS-VBM data.csv", stringsAsFactors = FALSE, check.names = FALSE)
```

```{r create new empty matrix for richness values}
rich.sums <- data.rich[0, 4:49]
rich.sums[1:13, 1] <- c("protozoans","other","rotifers","molluscs", "annelids","mites","cladocera","ostracoda","copepoda","amphipoda","shrimps","crabs","insects")
```

```{r use loop to calculte richness values per site for each of the twelve major taxon groups combined into one file}
row=0
for (i in c("^B","^I","^J","^K","^L","^M","^OG","^OH","^OJ","^OP","^OT","^OX","^Q"))
  {
  data.rich.temp <- data.rich[data.rich$LOWESTIDNC %like% i, ]
temp <- colSums(data.rich.temp[, 5:49])
row=row+1
rich.sums[row, 2:46] <- temp
}
```

```{r}
data.rich.temp <- data.rich[data.rich$LOWESTIDNC %like% "^B", ]
```







```{r calculate macrocrustacea and microcrustacea richness and delete individual crustacean orders}
rich.sums[13, 2:40] <- colSums(rich.sums[6:8, 2:40])
rich.sums[13, 1] <- "microcrustacea"
rich.sums[14, 2:40] <- colSums(rich.sums[9:11, 2:40])
rich.sums[14,1] <- "macrocrustacea"
rich.sums <-  rich.sums[!grepl("cladocera|ostracoda|copepoda|amphipoda|shrimps|crabs",rich.sums$LOWESTIDNC),] 
```

```{r add taxon names as row names and then convert to list format}
row.names(rich.sums) <- rich.sums[, 1]
rich.sums <- rich.sums[, -1]
rich.sums.list <- liste(t(rich.sums), x="taxon", y="sample", entry="richness")
```

```{r plot stacked column plot, 1990s}
ggplot(rich.sums.list[rich.sums.list$sample %like% "1996|1999|2000|2001|2003", ], aes(sample, richness, fill=factor(taxon,levels=c("protozoans","rotifers","molluscs","annelids","mites","microcrustacea","macrocrustacea","insects")))) + 
  scale_fill_brewer(palette="Set1") +  #use RColourBrewer package to set colours
  geom_bar(stat = "identity", colour="black") + #colour=black sets borders for the bars
  scale_y_continuous(limits=c(0, 100)) + #set y-limit to 100 for consistency
  guides(fill=guide_legend(title=NULL)) + #remove legend title
  theme_bw() + #remove background colour
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #remove gridlines
  theme(axis.text.x=element_text(angle = -90, vjust = 0.5)) #angle x axis labels
```

```{r plot stacked column plot, 1993 Halse et al. 1996 data}
ggplot(rich.sums.list[rich.sums.list$sample %like% "1993", ], aes(sample, richness, fill=factor(taxon,levels=c("protozoans","rotifers","molluscs","annelids","mites","microcrustacea","macrocrustacea","insects")))) + 
  scale_fill_brewer(palette="Set1") +  #use RColourBrewer package to set colours
  geom_bar(stat = "identity", colour="black") + #colour=black sets borders for the bars
  scale_y_continuous(limits=c(0, 100)) + #set y-limit to 100 for consistency
  guides(fill=guide_legend(title=NULL)) + #remove legend title
  theme_bw() + #remove background colour
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #remove gridlines
  theme(axis.text.x=element_text(angle = -90, vjust = 0.5)) #angle x axis labels
```


```{r plot stacked column plot, 2017 benthic/plankton data}
ggplot(rich.sums.list[rich.sums.list$sample %like% "2017-B|2017-P", ], aes(sample, richness, fill=factor(taxon,levels=c("protozoans","rotifers","molluscs","annelids","mites","microcrustacea","macrocrustacea","insects")))) + 
  scale_fill_brewer(palette="Set1") +  #use RColourBrewer package to set colours
  geom_bar(stat = "identity", colour="black") + #colour=black sets borders for the bars
  scale_y_continuous(limits=c(0, 100)) + #set y-limit to 100 for consistency
  guides(fill=guide_legend(title=NULL)) + #remove legend title
  theme_bw() + #remove background colour
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #remove gridlines
  theme(axis.text.x=element_text(angle = -90, vjust = 0.5)) #angle x axis labels
```


```{r plot stacked column plot, 2016 and 2017 core samples}
ggplot(rich.sums.list[rich.sums.list$sample %like% "2016|2017-C", ], aes(sample, richness, fill=factor(taxon,levels=c("protozoans","rotifers","molluscs","annelids","mites","microcrustacea","macrocrustacea","insects")))) + 
  scale_fill_brewer(palette="Set1") +  #use RColourBrewer package to set colours
  geom_bar(stat = "identity", colour="black") + #colour=black sets borders for the bars
  scale_y_continuous(limits=c(0, 100)) + #set y-limit to 100 for consistency
  guides(fill=guide_legend(title=NULL)) + #remove legend title
  theme_bw() + #remove background colour
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #remove gridlines
  theme(axis.text.x=element_text(angle = -90, vjust = 0.5)) #angle x axis labels
```

